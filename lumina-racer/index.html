<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Lumina Racer - Typing Racing Game</title>
  <meta name="description" content="Race through magical kingdoms by typing words! A Lumina educational game.">
  <meta name="theme-color" content="#1e1b4b">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèéÔ∏è</text></svg>">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- React & Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'title': ['Fredoka', 'sans-serif'],
            'game': ['Quicksand', 'sans-serif'],
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
            'race-pulse': 'racePulse 0.5s ease-out',
            'boost': 'boost 0.3s ease-out',
            'shake': 'shake 0.3s ease-out',
            'countdown': 'countdown 0.5s ease-out',
            'aurora-bounce': 'auroraBounce 0.5s ease-out',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            pulseGlow: {
              '0%, 100%': { boxShadow: '0 0 20px rgba(139, 92, 246, 0.3)' },
              '50%': { boxShadow: '0 0 40px rgba(139, 92, 246, 0.6)' },
            },
            racePulse: {
              '0%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.05)' },
              '100%': { transform: 'scale(1)' },
            },
            boost: {
              '0%': { transform: 'translateX(0)' },
              '50%': { transform: 'translateX(10px)' },
              '100%': { transform: 'translateX(0)' },
            },
            shake: {
              '0%, 100%': { transform: 'translateX(0)' },
              '25%': { transform: 'translateX(-5px)' },
              '75%': { transform: 'translateX(5px)' },
            },
            countdown: {
              '0%': { transform: 'scale(0.5)', opacity: '0' },
              '50%': { transform: 'scale(1.2)', opacity: '1' },
              '100%': { transform: 'scale(1)', opacity: '1' },
            },
            auroraBounce: {
              '0%': { transform: 'translateY(0) rotate(-5deg)' },
              '50%': { transform: 'translateY(-10px) rotate(5deg)' },
              '100%': { transform: 'translateY(0) rotate(-5deg)' },
            }
          }
        }
      }
    }
  </script>
  
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: 'Quicksand', sans-serif;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .game-bg {
      background: linear-gradient(180deg, 
        #0f0c29 0%, 
        #302b63 40%, 
        #24243e 70%,
        #1a1a2e 100%
      );
    }
    
    .track-bg {
      position: relative;
      overflow: hidden;
    }
    
    .stars {
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20px 30px, #eee, transparent),
        radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
        radial-gradient(1px 1px at 90px 40px, #fff, transparent),
        radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
        radial-gradient(1px 1px at 230px 80px, #ddd, transparent);
      background-repeat: repeat;
      background-size: 350px 250px;
      animation: twinkle 5s ease-in-out infinite alternate;
    }
    
    @keyframes twinkle {
      0% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .magic-input {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
      border: 3px solid rgba(139, 92, 246, 0.5);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.3), inset 0 0 20px rgba(139, 92, 246, 0.1);
    }
    
    .magic-input:focus {
      outline: none;
      border-color: rgba(167, 139, 250, 0.8);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.5), inset 0 0 30px rgba(139, 92, 246, 0.2);
    }
    
    .racer-track {
      background: linear-gradient(90deg, 
        rgba(139, 92, 246, 0.1) 0%,
        rgba(99, 102, 241, 0.15) 50%,
        rgba(139, 92, 246, 0.1) 100%
      );
      border-top: 2px solid rgba(139, 92, 246, 0.3);
      border-bottom: 2px solid rgba(139, 92, 246, 0.3);
    }
    
    .finish-line {
      background: repeating-linear-gradient(
        90deg,
        #fff 0px,
        #fff 10px,
        #1a1a2e 10px,
        #1a1a2e 20px
      );
    }
    
    .speed-lines {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .speed-lines.active {
      opacity: 1;
    }
    
    .speed-line {
      position: absolute;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      animation: speedLine 0.3s linear infinite;
    }
    
    @keyframes speedLine {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100%); }
    }
    
    .boost-effect {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: radial-gradient(ellipse at center, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
      animation: boostFlash 0.3s ease-out;
    }
    
    @keyframes boostFlash {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;
    
    // ==================== CONSTANTS ====================
    const DEFAULT_WORDS = [
      'magic', 'crystal', 'aurora', 'light', 'spark', 'glow', 'shine', 'star',
      'dream', 'wish', 'hope', 'brave', 'swift', 'dash', 'zoom', 'speed',
      'flame', 'frost', 'wind', 'storm', 'thunder', 'shadow', 'spirit', 'soul',
      'quest', 'hero', 'power', 'energy', 'force', 'boost', 'turbo', 'flash'
    ];
    
    // Liam's contraction words
    const LIAM_WORDS = [
      "won't", "aren't", "haven't", "he'd", "hasn't", "doesn't",
      "we'd", "hadn't", "weren't", "they'd", "i'm", "shouldn't",
      "they're", "i'd", "wouldn't", "should've", "would've", "couldn't"
    ];
    
    const TRACKS = [
      { 
        id: 'archives', 
        name: 'The Archives', 
        emoji: 'üìö',
        bg: 'from-amber-900 via-orange-800 to-amber-900',
        description: 'Race through floating books and ancient knowledge!',
        laps: 3
      },
      { 
        id: 'calculation', 
        name: 'Calculation Fields', 
        emoji: 'üî¢',
        bg: 'from-cyan-900 via-blue-800 to-indigo-900',
        description: 'Speed through geometric crystals and math symbols!',
        laps: 3
      },
      { 
        id: 'sanctuary', 
        name: 'The Sanctuary', 
        emoji: 'üè∞',
        bg: 'from-purple-900 via-violet-800 to-purple-900',
        description: 'Dash around the magical floating castle!',
        laps: 4
      },
      { 
        id: 'fog', 
        name: 'Fog Frontier', 
        emoji: 'üå´Ô∏è',
        bg: 'from-slate-800 via-gray-700 to-slate-800',
        description: 'Brave the mysterious edge of The Fog!',
        laps: 5
      }
    ];
    
    const CHARACTERS = {
      emma: {
        name: 'Emma',
        title: 'The Sage',
        emoji: 'üßô‚Äç‚ôÄÔ∏è',
        color: 'purple',
        special: 'Deep Focus',
        specialDesc: 'Extra time on hard words',
        avatar: '../assets/Emma_Lumina.png'
      },
      liam: {
        name: 'Liam', 
        title: 'The Scout',
        emoji: '‚öîÔ∏è',
        color: 'orange',
        special: 'Quick Instinct',
        specialDesc: 'Bonus boost for fast answers',
        avatar: '../assets/Liam_Lumina.png'
      }
    };
    
    const AI_RACERS = [
      { name: 'Shadow Runner', emoji: 'üëª', color: '#6b7280', difficulty: 0.35 },
      { name: 'Crystal Dasher', emoji: 'üíé', color: '#06b6d4', difficulty: 0.45 },
      { name: 'Storm Chaser', emoji: '‚ö°', color: '#f59e0b', difficulty: 0.55 },
    ];
    
    const AURORA_COMMENTS = {
      start: [
        "Let's GO! May the words be with you! ‚ú®",
        "Time to race! Remember, spelling is speed! ü¶ä",
        "Ready, set, TYPE! I believe in you! üí´"
      ],
      correct: [
        "YES! That's the spirit! üî•",
        "Perfect! Keep that momentum! ‚ö°",
        "Brilliant spelling! You're flying! üåü",
        "Magnificent! The Fog doesn't stand a chance! üíú"
      ],
      wrong: [
        "Oops! Shake it off, you've got this! üí™",
        "Close! Try the next one! ü¶ä",
        "Even I make mistakes... sometimes... rarely... üòÖ"
      ],
      boost: [
        "TURBO TIME! üöÄ",
        "MAXIMUM OVERDRIVE! ‚ö°",
        "WHOOOOSH! üí®"
      ],
      winning: [
        "You're in the lead! Don't look back! üëÄ",
        "FIRST PLACE! Keep typing! ü•á"
      ],
      losing: [
        "You can catch up! Type faster! üìù",
        "Don't give up! Every word counts! üíú"
      ],
      finish: [
        "INCREDIBLE! You did it! üéâ",
        "VICTORY! The Sanctuary celebrates! üèÜ",
        "CHAMPION! Step and Terra would be proud! ‚ù§Ô∏è"
      ],
      lostRace: [
        "Good effort! Practice makes perfect! üí™",
        "You'll get them next time! I know it! ü¶ä"
      ]
    };
    
    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
    const randomFrom = arr => arr[Math.floor(Math.random() * arr.length)];
    
    // ==================== SPEECH SYNTHESIS ====================
    const speakWord = (word) => {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        window.speechSynthesis.speak(utterance);
      }
    };
    
    // ==================== MAIN GAME COMPONENT ====================
    function LuminaRacer() {
      // Game state
      const [screen, setScreen] = useState('menu'); // menu, charSelect, trackSelect, countdown, racing, results
      const [character, setCharacter] = useState(null);
      const [track, setTrack] = useState(null);
      const [words, setWords] = useState(DEFAULT_WORDS);
      const [customWordsInput, setCustomWordsInput] = useState('');
      
      // Race state
      const [playerPosition, setPlayerPosition] = useState(0);
      const [aiPositions, setAiPositions] = useState([0, 0, 0]);
      const [currentLap, setCurrentLap] = useState(1);
      const [currentWord, setCurrentWord] = useState('');
      const [typedWord, setTypedWord] = useState('');
      const [wordsCompleted, setWordsCompleted] = useState(0);
      const [mistakes, setMistakes] = useState(0);
      const [combo, setCombo] = useState(0);
      const [maxCombo, setMaxCombo] = useState(0);
      const [boostActive, setBoostActive] = useState(false);
      const [countdown, setCountdown] = useState(3);
      const [raceTime, setRaceTime] = useState(0);
      const [finished, setFinished] = useState(false);
      const [finalPlace, setFinalPlace] = useState(0);
      const [showBoostEffect, setShowBoostEffect] = useState(false);
      
      // Aurora
      const [auroraMessage, setAuroraMessage] = useState('');
      const [auroraVisible, setAuroraVisible] = useState(false);
      
      // Refs
      const inputRef = useRef(null);
      const gameLoopRef = useRef(null);
      const raceTimerRef = useRef(null);
      const usedWordsRef = useRef(new Set());
      
      const TRACK_LENGTH = 100;
      const LAP_LENGTH = track ? TRACK_LENGTH / track.laps : 25;
      
      // Aurora speaks
      const auroraSpeak = useCallback((category) => {
        const message = randomFrom(AURORA_COMMENTS[category] || AURORA_COMMENTS.correct);
        setAuroraMessage(message);
        setAuroraVisible(true);
        setTimeout(() => setAuroraVisible(false), 2500);
      }, []);
      
      // Get next word
      const getNextWord = useCallback(() => {
        const available = words.filter(w => !usedWordsRef.current.has(w));
        if (available.length === 0) {
          usedWordsRef.current.clear();
          return words[Math.floor(Math.random() * words.length)];
        }
        const word = available[Math.floor(Math.random() * available.length)];
        usedWordsRef.current.add(word);
        return word;
      }, [words]);
      
      // Start countdown
      const startCountdown = useCallback(() => {
        setScreen('countdown');
        setCountdown(3);
        setPlayerPosition(0);
        setAiPositions([0, 0, 0]);
        setCurrentLap(1);
        setWordsCompleted(0);
        setMistakes(0);
        setCombo(0);
        setMaxCombo(0);
        setRaceTime(0);
        setFinished(false);
        setFinalPlace(0);
        usedWordsRef.current.clear();
        
        // Parse custom words or use character defaults
        let gameWords = character === 'liam' ? LIAM_WORDS : DEFAULT_WORDS;
        if (customWordsInput.trim()) {
          const custom = customWordsInput
            .toLowerCase()
            .split(/[\s,]+/)
            .map(w => w.trim())
            .filter(w => w.length >= 2);
          if (custom.length >= 5) {
            gameWords = custom;
          }
        }
        setWords(gameWords);
        
        const nextWord = gameWords[Math.floor(Math.random() * gameWords.length)];
        setCurrentWord(nextWord);
        setTypedWord('');
        
        auroraSpeak('start');
        
        let count = 3;
        const countInterval = setInterval(() => {
          count--;
          if (count > 0) {
            setCountdown(count);
          } else {
            clearInterval(countInterval);
            setScreen('racing');
            speakWord(nextWord);
            inputRef.current?.focus();
          }
        }, 1000);
      }, [character, customWordsInput, auroraSpeak]);
      
      // Game loop
      useEffect(() => {
        if (screen !== 'racing' || finished) return;
        
        const loop = setInterval(() => {
          // Move AI racers
          setAiPositions(prev => prev.map((pos, i) => {
            if (pos >= TRACK_LENGTH) return pos;
            const racer = AI_RACERS[i];
            const baseSpeed = 0.10 * racer.difficulty;
            const variance = (Math.random() - 0.5) * 0.1;
            return Math.min(TRACK_LENGTH, pos + baseSpeed + variance);
          }));
          
          // Update race time
          setRaceTime(t => t + 0.05);
        }, 50);
        
        gameLoopRef.current = loop;
        return () => clearInterval(loop);
      }, [screen, finished]);
      
      // Check for race completion
      useEffect(() => {
        if (screen !== 'racing' || finished) return;
        
        // Get all positions
        const positions = [
          { id: 'player', pos: playerPosition },
          ...aiPositions.map((pos, i) => ({ id: `ai${i}`, pos }))
        ].sort((a, b) => b.pos - a.pos);
        
        const playerRank = positions.findIndex(p => p.id === 'player') + 1;
        
        // Aurora commentary based on position
        if (playerPosition > 0 && playerPosition % 20 < 1) {
          if (playerRank === 1) {
            auroraSpeak('winning');
          } else if (playerRank > 2) {
            auroraSpeak('losing');
          }
        }
        
        // Check if player finished
        if (playerPosition >= TRACK_LENGTH) {
          setFinished(true);
          setFinalPlace(playerRank);
          if (playerRank === 1) {
            auroraSpeak('finish');
          } else {
            auroraSpeak('lostRace');
          }
          setTimeout(() => setScreen('results'), 1500);
        }
        
        // Check if all AI finished (player loses)
        if (aiPositions.every(p => p >= TRACK_LENGTH) && !finished) {
          setFinished(true);
          setFinalPlace(4);
          auroraSpeak('lostRace');
          setTimeout(() => setScreen('results'), 1500);
        }
      }, [playerPosition, aiPositions, screen, finished, auroraSpeak]);
      
      // Update current lap
      useEffect(() => {
        if (track && playerPosition > 0) {
          const newLap = Math.min(track.laps, Math.floor(playerPosition / LAP_LENGTH) + 1);
          if (newLap > currentLap) {
            setCurrentLap(newLap);
          }
        }
      }, [playerPosition, track, LAP_LENGTH, currentLap]);
      
      // Handle input
      const handleInputChange = useCallback((e) => {
        const val = e.target.value
          .toLowerCase()
          .replace(/[''`]/g, "'");
        setTypedWord(val);
        
        // Check if word is complete
        if (val === currentWord) {
          // Correct!
          const newCombo = combo + 1;
          setCombo(newCombo);
          setMaxCombo(m => Math.max(m, newCombo));
          setWordsCompleted(w => w + 1);
          
          // Calculate boost
          let boost = 3 + Math.min(newCombo * 0.5, 3);
          
          // Character special abilities
          if (character === 'liam' && val.length > 0) {
            // Quick Instinct - bonus for fast typing
            boost += 1;
          }
          
          // Big boost for combos
          if (newCombo >= 5 && newCombo % 5 === 0) {
            boost += 3;
            setBoostActive(true);
            setShowBoostEffect(true);
            auroraSpeak('boost');
            setTimeout(() => {
              setBoostActive(false);
              setShowBoostEffect(false);
            }, 500);
          } else {
            auroraSpeak('correct');
          }
          
          setPlayerPosition(p => Math.min(TRACK_LENGTH, p + boost));
          
          // Next word
          const nextWord = getNextWord();
          setCurrentWord(nextWord);
          setTypedWord('');
          speakWord(nextWord);
        }
      }, [currentWord, combo, character, getNextWord, auroraSpeak]);
      
      // Handle key press
      const handleKeyDown = useCallback((e) => {
        if (e.key === 'Escape' && screen === 'racing') {
          setScreen('trackSelect');
        } else if (e.key === 'Enter' && screen === 'racing') {
          // Check partial match for mistake
          if (typedWord && typedWord !== currentWord) {
            setMistakes(m => m + 1);
            setCombo(0);
            auroraSpeak('wrong');
            setTypedWord('');
          }
        }
      }, [screen, typedWord, currentWord, auroraSpeak]);
      
      // Calculate stats
      const accuracy = wordsCompleted > 0 
        ? Math.round((wordsCompleted / (wordsCompleted + mistakes)) * 100) 
        : 100;
      
      const wpm = raceTime > 0 
        ? Math.round((wordsCompleted / raceTime) * 60) 
        : 0;
      
      // ==================== RENDER ====================
      return (
        <div className="w-full h-screen game-bg overflow-hidden relative">
          <div className="stars" />
          
          {/* ==================== MENU ==================== */}
          {screen === 'menu' && (
            <div className="absolute inset-0 flex flex-col items-center justify-center z-20">
              <div className="text-center animate-float">
                <div className="text-8xl mb-4">üèéÔ∏è</div>
                <h1 className="font-title text-6xl md:text-7xl text-amber-400 mb-2"
                    style={{ textShadow: '0 0 30px rgba(251, 191, 36, 0.5), 0 4px 0 #92400e' }}>
                  LUMINA RACER
                </h1>
                <p className="font-game text-xl text-purple-300 mb-8">
                  Type to Race Through Magical Kingdoms! ü¶ä
                </p>
              </div>
              
              <button
                onClick={() => setScreen('charSelect')}
                className="px-12 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 
                         text-white font-title text-2xl rounded-xl shadow-lg hover:scale-105
                         border-2 border-purple-400/50 transition-all animate-pulse-glow"
              >
                üèÅ START RACING
              </button>
              
              <div className="mt-8 text-purple-400/60 font-game text-sm">
                Made with ‚ù§Ô∏è for Emma & Liam
              </div>
              
              {/* Aurora floating */}
              <div className="absolute bottom-8 right-8 text-6xl animate-float">
                ü¶ä
              </div>
            </div>
          )}
          
          {/* ==================== CHARACTER SELECT ==================== */}
          {screen === 'charSelect' && (
            <div className="absolute inset-0 flex flex-col items-center justify-center z-20 p-4">
              <h2 className="font-title text-4xl text-amber-400 mb-8 animate-float">
                Choose Your Racer
              </h2>
              
              <div className="flex gap-6 mb-8">
                {Object.entries(CHARACTERS).map(([key, char]) => (
                  <button
                    key={key}
                    onClick={() => {
                      setCharacter(key);
                      setScreen('trackSelect');
                    }}
                    className={`bg-slate-900/80 rounded-2xl p-6 border-2 transition-all hover:scale-105
                              ${char.color === 'purple' ? 'border-purple-500/50 hover:border-purple-400' : 'border-orange-500/50 hover:border-orange-400'}
                              ${char.color === 'purple' ? 'hover:shadow-[0_0_30px_rgba(147,51,234,0.3)]' : 'hover:shadow-[0_0_30px_rgba(249,115,22,0.3)]'}`}
                  >
                    <div className="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden border-4 border-white/20">
                      <img 
                        src={char.avatar} 
                        alt={char.name}
                        className="w-full h-full object-cover object-top"
                        onError={(e) => { e.target.style.display = 'none'; e.target.parentElement.innerHTML = `<span class="text-5xl flex items-center justify-center h-full">${char.emoji}</span>`; }}
                      />
                    </div>
                    <div className="font-title text-2xl text-white mb-1">{char.name}</div>
                    <div className={`font-game text-sm mb-3 ${char.color === 'purple' ? 'text-purple-400' : 'text-orange-400'}`}>
                      {char.title}
                    </div>
                    <div className="bg-slate-800 rounded-lg p-2">
                      <div className="font-game text-xs text-amber-400">‚ú® {char.special}</div>
                      <div className="font-game text-xs text-slate-400">{char.specialDesc}</div>
                    </div>
                  </button>
                ))}
              </div>
              
              <button
                onClick={() => setScreen('menu')}
                className="px-6 py-2 bg-slate-700 text-slate-300 font-game rounded-lg hover:bg-slate-600 transition-all"
              >
                ‚Üê Back
              </button>
            </div>
          )}
          
          {/* ==================== TRACK SELECT ==================== */}
          {screen === 'trackSelect' && (
            <div className="absolute inset-0 flex flex-col items-center justify-center z-20 p-4 overflow-auto">
              <h2 className="font-title text-4xl text-amber-400 mb-6">
                Select Your Track
              </h2>
              
              {/* Custom words input */}
              <div className="w-full max-w-lg mb-6">
                <label className="block text-purple-300 font-game mb-2 text-sm">
                  üìù Custom Spelling Words (optional)
                </label>
                <textarea
                  value={customWordsInput}
                  onChange={(e) => setCustomWordsInput(e.target.value)}
                  placeholder="Paste weekly spelling words here..."
                  className="w-full h-20 bg-slate-800 border-2 border-slate-600 rounded-lg p-3
                           text-white font-game text-sm resize-none focus:border-purple-500 focus:outline-none"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4 mb-6 max-w-2xl">
                {TRACKS.map(t => (
                  <button
                    key={t.id}
                    onClick={() => {
                      setTrack(t);
                      startCountdown();
                    }}
                    className={`bg-gradient-to-br ${t.bg} rounded-2xl p-4 border-2 border-white/20 
                              transition-all hover:scale-105 hover:border-white/40 text-left`}
                  >
                    <div className="text-4xl mb-2">{t.emoji}</div>
                    <div className="font-title text-xl text-white">{t.name}</div>
                    <div className="font-game text-xs text-white/70 mb-2">{t.description}</div>
                    <div className="font-game text-xs text-amber-400">{t.laps} Laps</div>
                  </button>
                ))}
              </div>
              
              <button
                onClick={() => setScreen('charSelect')}
                className="px-6 py-2 bg-slate-700 text-slate-300 font-game rounded-lg hover:bg-slate-600 transition-all"
              >
                ‚Üê Change Character
              </button>
            </div>
          )}
          
          {/* ==================== COUNTDOWN ==================== */}
          {screen === 'countdown' && (
            <div className="absolute inset-0 flex items-center justify-center z-30 bg-black/50">
              <div className="text-center">
                <div className="font-title text-9xl text-amber-400 animate-countdown"
                     key={countdown}
                     style={{ textShadow: '0 0 50px rgba(251, 191, 36, 0.8)' }}>
                  {countdown}
                </div>
                <div className="font-game text-2xl text-purple-300 mt-4">
                  Get Ready to Race!
                </div>
              </div>
            </div>
          )}
          
          {/* ==================== RACING ==================== */}
          {screen === 'racing' && (
            <div className={`absolute inset-0 track-bg bg-gradient-to-b ${track?.bg || 'from-purple-900 to-indigo-900'}`}>
              {/* Speed lines effect */}
              <div className={`speed-lines ${boostActive ? 'active' : ''}`}>
                {[...Array(10)].map((_, i) => (
                  <div 
                    key={i}
                    className="speed-line"
                    style={{ 
                      top: `${10 + i * 8}%`, 
                      width: `${Math.random() * 100 + 50}px`,
                      animationDelay: `${i * 0.1}s`
                    }}
                  />
                ))}
              </div>
              
              {/* Boost effect */}
              {showBoostEffect && <div className="boost-effect" />}
              
              {/* HUD - Top */}
              <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-start z-10">
                <div className="bg-slate-900/80 rounded-xl p-3 border border-purple-500/30">
                  <div className="font-game text-amber-400">
                    {track?.emoji} {track?.name}
                  </div>
                  <div className="font-title text-white text-2xl">
                    Lap {currentLap}/{track?.laps}
                  </div>
                </div>
                
                <div className="bg-slate-900/80 rounded-xl p-3 border border-purple-500/30 text-center">
                  <div className="font-game text-purple-300 text-sm">Time</div>
                  <div className="font-title text-white text-xl">
                    {Math.floor(raceTime)}:{String(Math.floor((raceTime % 1) * 100)).padStart(2, '0')}
                  </div>
                </div>
                
                <div className="bg-slate-900/80 rounded-xl p-3 border border-purple-500/30 text-right">
                  <div className="font-game text-green-400">Words: {wordsCompleted}</div>
                  {combo > 1 && (
                    <div className="font-title text-orange-400 animate-race-pulse">
                      üî• {combo}x Combo!
                    </div>
                  )}
                </div>
              </div>
              
              {/* Race Track Visual */}
              <div className="absolute left-4 right-4 top-1/4" style={{ height: '45%' }}>
                {/* Finish line */}
                <div className="absolute right-0 top-0 bottom-0 w-4 finish-line rounded-r" />
                
                {/* AI Racers */}
                {AI_RACERS.map((racer, i) => (
                  <div
                    key={i}
                    className="racer-track h-12 mb-2 relative rounded-lg flex items-center"
                  >
                    <div 
                      className="absolute text-3xl transition-all duration-100"
                      style={{ 
                        left: `${Math.min(95, aiPositions[i])}%`,
                        filter: `drop-shadow(0 0 10px ${racer.color})`
                      }}
                    >
                      {racer.emoji}
                    </div>
                    <div className="absolute left-2 font-game text-xs text-white/50">
                      {racer.name}
                    </div>
                  </div>
                ))}
                
                {/* Player Track */}
                <div className="racer-track h-16 relative rounded-lg flex items-center border-2 border-amber-500/50">
                  <div 
                    className={`absolute text-4xl transition-all duration-100 ${boostActive ? 'animate-boost' : ''}`}
                    style={{ 
                      left: `${Math.min(95, playerPosition)}%`,
                      filter: 'drop-shadow(0 0 15px rgba(251, 191, 36, 0.8))'
                    }}
                  >
                    {CHARACTERS[character]?.emoji || 'üèéÔ∏è'}
                  </div>
                  <div className="absolute left-2 font-title text-sm text-amber-400">
                    {CHARACTERS[character]?.name || 'You'}
                  </div>
                </div>
              </div>
              
              {/* Aurora Commentary */}
              {auroraVisible && (
                <div className="absolute top-1/4 left-1/2 -translate-x-1/2 -translate-y-full z-20">
                  <div className="bg-slate-900/90 rounded-2xl p-4 border-2 border-amber-500/50 flex items-center gap-3 animate-aurora-bounce">
                    <span className="text-4xl">ü¶ä</span>
                    <span className="font-game text-white text-lg">{auroraMessage}</span>
                  </div>
                </div>
              )}
              
              {/* Word Input Area */}
              <div className="absolute bottom-0 left-0 right-0 p-6 bg-slate-900/90 border-t border-purple-500/30">
                <div className="max-w-2xl mx-auto">
                  {/* Current Word Display */}
                  <div className="text-center mb-4">
                    <div className="inline-flex items-center gap-3 bg-slate-800 rounded-xl px-6 py-3 border-2 border-purple-500/50">
                      <span className="font-title text-3xl text-white tracking-wider">
                        {currentWord.split('').map((char, i) => (
                          <span 
                            key={i}
                            className={i < typedWord.length && currentWord.startsWith(typedWord) 
                              ? 'text-green-400' 
                              : 'text-white'}
                          >
                            {char}
                          </span>
                        ))}
                      </span>
                      <button
                        onClick={() => speakWord(currentWord)}
                        className="text-purple-400 hover:text-purple-300 text-xl"
                      >
                        üîä
                      </button>
                    </div>
                  </div>
                  
                  {/* Input */}
                  <input
                    ref={inputRef}
                    type="text"
                    value={typedWord}
                    onChange={handleInputChange}
                    onKeyDown={handleKeyDown}
                    autoFocus
                    autoComplete="off"
                    autoCorrect="off"
                    autoCapitalize="off"
                    spellCheck={false}
                    placeholder="Type here..."
                    className="magic-input w-full px-6 py-4 rounded-xl text-center
                             font-game text-2xl text-white placeholder-purple-400/50"
                  />
                  
                  <p className="text-center text-slate-500 text-sm mt-2 font-game">
                    Press ESC to quit race
                  </p>
                </div>
              </div>
            </div>
          )}
          
          {/* ==================== RESULTS ==================== */}
          {screen === 'results' && (
            <div className="absolute inset-0 flex items-center justify-center z-30 bg-black/70">
              <div className="bg-slate-900 rounded-3xl p-8 max-w-md w-full mx-4 border-2 border-purple-500/50 text-center">
                {/* Trophy/Place */}
                <div className="text-7xl mb-4">
                  {finalPlace === 1 ? 'üèÜ' : finalPlace === 2 ? 'ü•à' : finalPlace === 3 ? 'ü•â' : 'üèÅ'}
                </div>
                
                <h2 className={`font-title text-4xl mb-2 ${finalPlace === 1 ? 'text-amber-400' : 'text-purple-400'}`}>
                  {finalPlace === 1 ? 'CHAMPION!' : finalPlace <= 3 ? `${finalPlace}${finalPlace === 2 ? 'nd' : 'rd'} Place!` : 'Race Complete!'}
                </h2>
                
                <p className="font-game text-slate-400 mb-6">
                  {finalPlace === 1 ? 'You conquered the track!' : 'Great effort, keep practicing!'}
                </p>
                
                {/* Stats */}
                <div className="bg-slate-800 rounded-xl p-4 mb-6 text-left font-game">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="text-slate-400">Track:</div>
                    <div className="text-white text-right">{track?.emoji} {track?.name}</div>
                    <div className="text-slate-400">Time:</div>
                    <div className="text-white text-right">
                      {Math.floor(raceTime)}:{String(Math.floor((raceTime % 1) * 100)).padStart(2, '0')}
                    </div>
                    <div className="text-slate-400">Words Typed:</div>
                    <div className="text-amber-400 text-right">{wordsCompleted}</div>
                    <div className="text-slate-400">Accuracy:</div>
                    <div className="text-green-400 text-right">{accuracy}%</div>
                    <div className="text-slate-400">Best Combo:</div>
                    <div className="text-orange-400 text-right">{maxCombo}x</div>
                    <div className="text-slate-400">WPM:</div>
                    <div className="text-purple-400 text-right">{wpm}</div>
                  </div>
                </div>
                
                {/* Aurora comment */}
                <div className="flex items-center justify-center gap-3 bg-amber-500/10 rounded-xl p-3 mb-6">
                  <span className="text-3xl">ü¶ä</span>
                  <span className="font-game text-amber-400">
                    {finalPlace === 1 
                      ? "INCREDIBLE! You're a true Lumina champion!" 
                      : "Keep practicing! Every race makes you faster!"}
                  </span>
                </div>
                
                {/* Buttons */}
                <div className="flex gap-4">
                  <button
                    onClick={() => setScreen('trackSelect')}
                    className="flex-1 py-3 bg-slate-700 text-slate-300 font-game rounded-lg
                             hover:bg-slate-600 transition-all"
                  >
                    üó∫Ô∏è Tracks
                  </button>
                  <button
                    onClick={startCountdown}
                    className="flex-1 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 
                             text-white font-game rounded-lg hover:scale-105 transition-all"
                  >
                    üîÑ Race Again
                  </button>
                </div>
                
                <button
                  onClick={() => setScreen('menu')}
                  className="w-full mt-3 py-2 text-slate-500 font-game text-sm hover:text-slate-400"
                >
                  ‚Üê Main Menu
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }
    
    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<LuminaRacer />);
  </script>
</body>
</html>
