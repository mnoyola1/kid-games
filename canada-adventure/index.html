<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Canada Adventure - Pixel RPG</title>
  <meta name="description" content="An educational pixel art RPG adventure through Canada for kids">
  <meta name="theme-color" content="#dc2626">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÅ</text></svg>">
  
  <!-- React & Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lumina Core Integration -->
  <script src="../shared/lumina-core.js"></script>
  
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    button {
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    @keyframes float { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-6px); } 
    }
    
    @keyframes shake { 
      0%, 100% { transform: translateX(0); } 
      50% { transform: translateX(-5px); } 
    }
    
    @keyframes pulse { 
      0%, 100% { opacity: 1; } 
      50% { opacity: 0.5; } 
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Lumina Core integration flag - set to true to sync with hub
    const LUMINA_ENABLED = typeof LuminaCore !== 'undefined';

    // All questions from the study guide
    const allQuestions = [
      { q: 'How many sides of Canada are surrounded by oceans?', a: 'Three', wrong: ['Two', 'Four', 'One'], region: 'atlantic' },
      { q: 'What is east of the Canadian Rockies where farmers grow wheat?', a: 'The Central Plains', wrong: ['The Tundra', 'The Coastline', 'The Canadian Shield'], region: 'plains' },
      { q: 'Which city has the largest population in Canada?', a: 'Toronto', wrong: ['Montreal', 'Vancouver', 'Quebec City'], region: 'ontario' },
      { q: 'Where is Banff located?', a: 'The Central Plains region', wrong: ['The Coastline', 'The Tundra', 'The Atlantic region'], region: 'rockies' },
      { q: 'In which city do people speak both French and English?', a: 'Montreal', wrong: ['Toronto', 'Vancouver', 'Ottawa'], region: 'quebec' },
      { q: 'How did Native Canadians first arrive from Asia?', a: 'By traveling the land bridge', wrong: ['By boat', 'By airplane', 'By swimming'], region: 'arctic' },
      { q: 'Which French explorer founded Quebec City?', a: 'Samuel de Champlain', wrong: ['Jacques Cartier', 'Louis Riel', 'Pierre Trudeau'], region: 'quebec' },
      { q: 'Which war was fought between France and England for control of Canada?', a: "The Seven Years' War", wrong: ['World War I', 'The War of 1812', 'The Cold War'], region: 'quebec' },
      { q: 'When was Canada able to make its own laws for the first time?', a: '1931', wrong: ['1867', '1901', '1982'], region: 'ontario' },
      { q: 'What is the legislative branch in Canada called?', a: 'Parliament', wrong: ['Congress', 'Senate', 'Assembly'], region: 'ontario' },
      { q: "What is Canada's most important international trade partner?", a: 'United States', wrong: ['China', 'Mexico', 'United Kingdom'], region: 'plains' },
      { q: 'What do Canadians use wood to make?', a: 'Paper', wrong: ['Plastic', 'Metal', 'Glass'], region: 'shield' },
      { q: 'Jobs where workers help someone are part of what industries?', a: 'Service industries', wrong: ['Manufacturing', 'Mining', 'Farming'], region: 'ontario' },
      { q: 'What tree gives Canada its syrup AND national symbol?', a: 'Maple', wrong: ['Oak', 'Pine', 'Birch'], region: 'quebec' },
      { q: 'What is a PRAIRIE?', a: 'Flat land covered with grass', wrong: ['Frozen land without trees', 'Land along an ocean', 'A mountain range'], region: 'plains' },
      { q: 'What is a TUNDRA?', a: 'Frozen land without trees', wrong: ['A grassy plain', 'A forest', 'A river valley'], region: 'arctic' },
      { q: 'What is a REGION?', a: 'An area with common features', wrong: ['A type of government', 'A kind of animal', 'A frozen lake'], region: 'plains' },
      { q: 'What is a LOWLAND?', a: 'Area lower than land around it', wrong: ['A tall mountain', 'Land along the ocean', 'A frozen area'], region: 'atlantic' },
      { q: 'What is a COASTLINE?', a: 'Land along an ocean', wrong: ['A frozen area', 'A prairie', 'A mountain top'], region: 'atlantic' },
      { q: 'Who are the INUIT?', a: 'Arctic people in northern Canada', wrong: ['French explorers', 'British soldiers', 'American traders'], region: 'arctic' },
      { q: 'What is a PROVINCE?', a: 'Political area of a country', wrong: ['A type of food', 'A frozen river', 'A kind of tree'], region: 'ontario' },
      { q: 'What does BARTER mean?', a: 'Trade without using money', wrong: ['To build a house', 'To travel by boat', 'To grow wheat'], region: 'arctic' },
      { q: 'Which animal lives in the Canadian Shield?', a: 'Moose', wrong: ['Penguin', 'Kangaroo', 'Lion'], region: 'shield' },
      { q: 'Which animal lives in the Canadian Shield?', a: 'Gray wolves', wrong: ['Elephant', 'Giraffe', 'Zebra'], region: 'shield' },
      { q: 'Which animal can you find in the Canadian Shield?', a: 'Deer', wrong: ['Polar bear', 'Tiger', 'Hippo'], region: 'shield' },
    ];

    const regions = [
      { id: 'atlantic', name: 'Atlantic', color: '#3b82f6', bg: 'from-blue-400 to-blue-600', unlockLevel: 1 },
      { id: 'quebec', name: 'Quebec', color: '#8b5cf6', bg: 'from-purple-400 to-purple-600', unlockLevel: 2 },
      { id: 'ontario', name: 'Ontario', color: '#f59e0b', bg: 'from-amber-400 to-orange-500', unlockLevel: 3 },
      { id: 'shield', name: 'Shield', color: '#10b981', bg: 'from-green-400 to-green-600', unlockLevel: 4 },
      { id: 'plains', name: 'Plains', color: '#eab308', bg: 'from-yellow-400 to-amber-500', unlockLevel: 5 },
      { id: 'rockies', name: 'Rockies', color: '#64748b', bg: 'from-gray-400 to-slate-600', unlockLevel: 6 },
      { id: 'arctic', name: 'Arctic', color: '#06b6d4', bg: 'from-cyan-300 to-blue-500', unlockLevel: 7 },
    ];

    const monsters = {
      atlantic: [
        { name: 'Sea Serpent', hp: 2, attack: 1, sprite: 'serpent' },
        { name: 'Lobster Knight', hp: 4, attack: 2, sprite: 'lobster', isBoss: true },
      ],
      quebec: [
        { name: 'Maple Golem', hp: 3, attack: 1, sprite: 'golem' },
        { name: 'French Fox', hp: 5, attack: 2, sprite: 'fox', isBoss: true },
      ],
      ontario: [
        { name: 'City Slime', hp: 3, attack: 1, sprite: 'slime' },
        { name: 'Tower Bot', hp: 6, attack: 2, sprite: 'robot', isBoss: true },
      ],
      shield: [
        { name: 'Wolf Pack', hp: 3, attack: 2, sprite: 'wolf' },
        { name: 'Forest Troll', hp: 6, attack: 2, sprite: 'troll', isBoss: true },
      ],
      plains: [
        { name: 'Wheat Wraith', hp: 4, attack: 1, sprite: 'wraith' },
        { name: 'Tornado Spirit', hp: 6, attack: 3, sprite: 'tornado', isBoss: true },
      ],
      rockies: [
        { name: 'Mountain Yeti', hp: 5, attack: 2, sprite: 'yeti' },
        { name: 'Rock Golem', hp: 7, attack: 3, sprite: 'rockgolem', isBoss: true },
      ],
      arctic: [
        { name: 'Ice Dragon', hp: 5, attack: 2, sprite: 'dragon' },
        { name: 'Blizzard Witch', hp: 8, attack: 3, sprite: 'witch', isBoss: true },
      ],
    };

    const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);

    // CSS Box-Shadow Pixel Art
    const PixelSprite = ({ type, scale = 3, isHit, isAttacking, flip }) => {
      const sprites = {
        hero: [
          [4,0,'#8B4513'],[5,0,'#8B4513'],[6,0,'#8B4513'],[7,0,'#8B4513'],
          [3,1,'#8B4513'],[4,1,'#8B4513'],[5,1,'#8B4513'],[6,1,'#8B4513'],[7,1,'#8B4513'],[8,1,'#8B4513'],
          [3,2,'#FFDAB9'],[4,2,'#FFDAB9'],[5,2,'#FFDAB9'],[6,2,'#FFDAB9'],[7,2,'#FFDAB9'],[8,2,'#FFDAB9'],
          [3,3,'#FFDAB9'],[4,3,'#1a1a2e'],[5,3,'#FFDAB9'],[6,3,'#FFDAB9'],[7,3,'#1a1a2e'],[8,3,'#FFDAB9'],
          [3,4,'#FFDAB9'],[4,4,'#FFDAB9'],[5,4,'#FFDAB9'],[6,4,'#FFDAB9'],[7,4,'#FFDAB9'],[8,4,'#FFDAB9'],
          [4,5,'#FFDAB9'],[5,5,'#FF6B6B'],[6,5,'#FF6B6B'],[7,5,'#FFDAB9'],
          [2,6,'#DC2626'],[3,6,'#DC2626'],[4,6,'#DC2626'],[5,6,'#DC2626'],[6,6,'#DC2626'],[7,6,'#DC2626'],[8,6,'#DC2626'],[9,6,'#DC2626'],
          [2,7,'#DC2626'],[3,7,'#DC2626'],[4,7,'#FBBF24'],[5,7,'#FBBF24'],[6,7,'#FBBF24'],[7,7,'#FBBF24'],[8,7,'#DC2626'],[9,7,'#DC2626'],
          [3,8,'#DC2626'],[4,8,'#FBBF24'],[5,8,'#FBBF24'],[6,8,'#FBBF24'],[7,8,'#FBBF24'],[8,8,'#DC2626'],
          [3,9,'#1E40AF'],[4,9,'#1E40AF'],[5,9,'#1E40AF'],[6,9,'#1E40AF'],[7,9,'#1E40AF'],[8,9,'#1E40AF'],
          [3,10,'#1E40AF'],[4,10,'#1E40AF'],[7,10,'#1E40AF'],[8,10,'#1E40AF'],
          [2,11,'#5C4033'],[3,11,'#5C4033'],[4,11,'#5C4033'],[7,11,'#5C4033'],[8,11,'#5C4033'],[9,11,'#5C4033'],
        ],
        serpent: [
          [6,0,'#1E90FF'],[7,0,'#1E90FF'],
          [5,1,'#1E90FF'],[6,1,'#1E90FF'],[7,1,'#1E90FF'],[8,1,'#1E90FF'],
          [4,2,'#1E90FF'],[5,2,'#FFD700'],[6,2,'#1E90FF'],[7,2,'#FFD700'],[8,2,'#1E90FF'],[9,2,'#1E90FF'],
          [3,3,'#1E90FF'],[4,3,'#1E90FF'],[5,3,'#1E90FF'],[6,3,'#1E90FF'],[7,3,'#1E90FF'],[8,3,'#1E90FF'],[9,3,'#1E90FF'],
          [2,4,'#4169E1'],[3,4,'#1E90FF'],[4,4,'#1E90FF'],[5,4,'#1E90FF'],[6,4,'#1E90FF'],[7,4,'#1E90FF'],[8,4,'#1E90FF'],
          [3,5,'#4169E1'],[4,5,'#1E90FF'],[5,5,'#1E90FF'],[6,5,'#1E90FF'],[7,5,'#1E90FF'],
          [4,6,'#4169E1'],[5,6,'#1E90FF'],[6,6,'#1E90FF'],[7,6,'#1E90FF'],
          [5,7,'#4169E1'],[6,7,'#1E90FF'],[7,7,'#1E90FF'],
          [6,8,'#4169E1'],[7,8,'#1E90FF'],
        ],
        lobster: [
          [1,0,'#DC2626'],[2,0,'#DC2626'],[9,0,'#DC2626'],[10,0,'#DC2626'],
          [0,1,'#DC2626'],[1,1,'#DC2626'],[2,1,'#DC2626'],[9,1,'#DC2626'],[10,1,'#DC2626'],[11,1,'#DC2626'],
          [1,2,'#DC2626'],[2,2,'#DC2626'],[3,2,'#B91C1C'],[4,2,'#B91C1C'],[5,2,'#B91C1C'],[6,2,'#B91C1C'],[7,2,'#B91C1C'],[8,2,'#B91C1C'],[9,2,'#DC2626'],[10,2,'#DC2626'],
          [3,3,'#B91C1C'],[4,3,'#FFD700'],[5,3,'#B91C1C'],[6,3,'#B91C1C'],[7,3,'#FFD700'],[8,3,'#B91C1C'],
          [2,4,'#FBBF24'],[3,4,'#B91C1C'],[4,4,'#B91C1C'],[5,4,'#B91C1C'],[6,4,'#B91C1C'],[7,4,'#B91C1C'],[8,4,'#B91C1C'],[9,4,'#FBBF24'],
          [2,5,'#FBBF24'],[3,5,'#FBBF24'],[4,5,'#B91C1C'],[5,5,'#B91C1C'],[6,5,'#B91C1C'],[7,5,'#B91C1C'],[8,5,'#FBBF24'],[9,5,'#FBBF24'],
          [4,6,'#B91C1C'],[5,6,'#B91C1C'],[6,6,'#B91C1C'],[7,6,'#B91C1C'],
          [3,7,'#DC2626'],[4,7,'#DC2626'],[7,7,'#DC2626'],[8,7,'#DC2626'],
        ],
        golem: [
          [4,0,'#DC2626'],[5,0,'#DC2626'],[6,0,'#DC2626'],[7,0,'#DC2626'],
          [3,1,'#8B4513'],[4,1,'#DC2626'],[5,1,'#DC2626'],[6,1,'#DC2626'],[7,1,'#DC2626'],[8,1,'#8B4513'],
          [3,2,'#8B4513'],[4,2,'#8B4513'],[5,2,'#8B4513'],[6,2,'#8B4513'],[7,2,'#8B4513'],[8,2,'#8B4513'],
          [2,3,'#8B4513'],[3,3,'#FFD700'],[4,3,'#8B4513'],[5,3,'#8B4513'],[6,3,'#8B4513'],[7,3,'#FFD700'],[8,3,'#8B4513'],[9,3,'#8B4513'],
          [2,4,'#A0522D'],[3,4,'#8B4513'],[4,4,'#8B4513'],[5,4,'#8B4513'],[6,4,'#8B4513'],[7,4,'#8B4513'],[8,4,'#8B4513'],[9,4,'#A0522D'],
          [2,5,'#A0522D'],[3,5,'#A0522D'],[4,5,'#8B4513'],[5,5,'#8B4513'],[6,5,'#8B4513'],[7,5,'#8B4513'],[8,5,'#A0522D'],[9,5,'#A0522D'],
          [3,6,'#A0522D'],[4,6,'#A0522D'],[5,6,'#8B4513'],[6,6,'#8B4513'],[7,6,'#A0522D'],[8,6,'#A0522D'],
          [3,7,'#5C4033'],[4,7,'#5C4033'],[7,7,'#5C4033'],[8,7,'#5C4033'],
        ],
        fox: [
          [3,0,'#EA580C'],[4,0,'#EA580C'],[7,0,'#EA580C'],[8,0,'#EA580C'],
          [3,1,'#EA580C'],[4,1,'#FFF'],[7,1,'#FFF'],[8,1,'#EA580C'],
          [2,2,'#EA580C'],[3,2,'#EA580C'],[4,2,'#EA580C'],[5,2,'#EA580C'],[6,2,'#EA580C'],[7,2,'#EA580C'],[8,2,'#EA580C'],[9,2,'#EA580C'],
          [2,3,'#EA580C'],[3,3,'#000'],[4,3,'#EA580C'],[5,3,'#FFF'],[6,3,'#FFF'],[7,3,'#EA580C'],[8,3,'#000'],[9,3,'#EA580C'],
          [3,4,'#EA580C'],[4,4,'#FFF'],[5,4,'#FFF'],[6,4,'#FFF'],[7,4,'#FFF'],[8,4,'#EA580C'],
          [4,5,'#EA580C'],[5,5,'#000'],[6,5,'#000'],[7,5,'#EA580C'],
          [3,6,'#EA580C'],[4,6,'#EA580C'],[5,6,'#EA580C'],[6,6,'#EA580C'],[7,6,'#EA580C'],[8,6,'#EA580C'],
          [2,7,'#EA580C'],[3,7,'#EA580C'],[8,7,'#EA580C'],[9,7,'#EA580C'],
          [1,8,'#EA580C'],[9,8,'#EA580C'],[10,8,'#EA580C'],[11,8,'#FDBA74'],
        ],
        slime: [
          [4,1,'#84CC16'],[5,1,'#84CC16'],[6,1,'#84CC16'],[7,1,'#84CC16'],
          [3,2,'#84CC16'],[4,2,'#84CC16'],[5,2,'#84CC16'],[6,2,'#84CC16'],[7,2,'#84CC16'],[8,2,'#84CC16'],
          [2,3,'#84CC16'],[3,3,'#84CC16'],[4,3,'#000'],[5,3,'#84CC16'],[6,3,'#84CC16'],[7,3,'#000'],[8,3,'#84CC16'],[9,3,'#84CC16'],
          [2,4,'#84CC16'],[3,4,'#84CC16'],[4,4,'#84CC16'],[5,4,'#84CC16'],[6,4,'#84CC16'],[7,4,'#84CC16'],[8,4,'#84CC16'],[9,4,'#84CC16'],
          [2,5,'#65A30D'],[3,5,'#84CC16'],[4,5,'#84CC16'],[5,5,'#84CC16'],[6,5,'#84CC16'],[7,5,'#84CC16'],[8,5,'#84CC16'],[9,5,'#65A30D'],
          [3,6,'#65A30D'],[4,6,'#65A30D'],[5,6,'#84CC16'],[6,6,'#84CC16'],[7,6,'#65A30D'],[8,6,'#65A30D'],
          [4,7,'#65A30D'],[5,7,'#65A30D'],[6,7,'#65A30D'],[7,7,'#65A30D'],
        ],
        robot: [
          [4,0,'#FFD700'],[5,0,'#FFD700'],[6,0,'#FFD700'],[7,0,'#FFD700'],
          [3,1,'#6B7280'],[4,1,'#9CA3AF'],[5,1,'#9CA3AF'],[6,1,'#9CA3AF'],[7,1,'#9CA3AF'],[8,1,'#6B7280'],
          [3,2,'#6B7280'],[4,2,'#EF4444'],[5,2,'#6B7280'],[6,2,'#6B7280'],[7,2,'#EF4444'],[8,2,'#6B7280'],
          [3,3,'#6B7280'],[4,3,'#6B7280'],[5,3,'#6B7280'],[6,3,'#6B7280'],[7,3,'#6B7280'],[8,3,'#6B7280'],
          [2,4,'#9CA3AF'],[3,4,'#6B7280'],[4,4,'#6B7280'],[5,4,'#6B7280'],[6,4,'#6B7280'],[7,4,'#6B7280'],[8,4,'#6B7280'],[9,4,'#9CA3AF'],
          [2,5,'#9CA3AF'],[3,5,'#4B5563'],[4,5,'#FFD700'],[5,5,'#FFD700'],[6,5,'#FFD700'],[7,5,'#FFD700'],[8,5,'#4B5563'],[9,5,'#9CA3AF'],
          [3,6,'#4B5563'],[4,6,'#4B5563'],[5,6,'#4B5563'],[6,6,'#4B5563'],[7,6,'#4B5563'],[8,6,'#4B5563'],
          [3,7,'#6B7280'],[4,7,'#6B7280'],[7,7,'#6B7280'],[8,7,'#6B7280'],
          [2,8,'#4B5563'],[3,8,'#4B5563'],[8,8,'#4B5563'],[9,8,'#4B5563'],
        ],
        wolf: [
          [2,0,'#6B7280'],[3,0,'#6B7280'],[8,0,'#6B7280'],[9,0,'#6B7280'],
          [2,1,'#6B7280'],[3,1,'#9CA3AF'],[8,1,'#9CA3AF'],[9,1,'#6B7280'],
          [1,2,'#6B7280'],[2,2,'#6B7280'],[3,2,'#6B7280'],[4,2,'#6B7280'],[5,2,'#6B7280'],[6,2,'#6B7280'],[7,2,'#6B7280'],[8,2,'#6B7280'],[9,2,'#6B7280'],[10,2,'#6B7280'],
          [1,3,'#6B7280'],[2,3,'#FFD700'],[3,3,'#6B7280'],[4,3,'#6B7280'],[5,3,'#9CA3AF'],[6,3,'#9CA3AF'],[7,3,'#6B7280'],[8,3,'#6B7280'],[9,3,'#FFD700'],[10,3,'#6B7280'],
          [2,4,'#6B7280'],[3,4,'#6B7280'],[4,4,'#9CA3AF'],[5,4,'#9CA3AF'],[6,4,'#9CA3AF'],[7,4,'#9CA3AF'],[8,4,'#6B7280'],[9,4,'#6B7280'],
          [3,5,'#6B7280'],[4,5,'#6B7280'],[5,5,'#000'],[6,5,'#000'],[7,5,'#6B7280'],[8,5,'#6B7280'],
          [2,6,'#6B7280'],[3,6,'#6B7280'],[4,6,'#FFF'],[5,6,'#FFF'],[6,6,'#FFF'],[7,6,'#FFF'],[8,6,'#6B7280'],[9,6,'#6B7280'],
          [3,7,'#4B5563'],[4,7,'#4B5563'],[7,7,'#4B5563'],[8,7,'#4B5563'],
        ],
        troll: [
          [4,0,'#166534'],[5,0,'#166534'],[6,0,'#166534'],[7,0,'#166534'],
          [3,1,'#166534'],[4,1,'#166534'],[5,1,'#166534'],[6,1,'#166534'],[7,1,'#166534'],[8,1,'#166534'],
          [2,2,'#166534'],[3,2,'#FFD700'],[4,2,'#166534'],[5,2,'#166534'],[6,2,'#166534'],[7,2,'#FFD700'],[8,2,'#166534'],[9,2,'#166534'],
          [2,3,'#15803D'],[3,3,'#166534'],[4,3,'#166534'],[5,3,'#166534'],[6,3,'#166534'],[7,3,'#166534'],[8,3,'#166534'],[9,3,'#15803D'],
          [2,4,'#15803D'],[3,4,'#166534'],[4,4,'#FFF'],[5,4,'#FFF'],[6,4,'#FFF'],[7,4,'#FFF'],[8,4,'#166534'],[9,4,'#15803D'],
          [1,5,'#5C4033'],[2,5,'#15803D'],[3,5,'#15803D'],[4,5,'#166534'],[5,5,'#166534'],[6,5,'#166534'],[7,5,'#166534'],[8,5,'#15803D'],[9,5,'#15803D'],[10,5,'#5C4033'],
          [1,6,'#5C4033'],[2,6,'#5C4033'],[3,6,'#15803D'],[4,6,'#15803D'],[5,6,'#15803D'],[6,6,'#15803D'],[7,6,'#15803D'],[8,6,'#15803D'],[9,6,'#5C4033'],[10,6,'#5C4033'],
          [3,7,'#15803D'],[4,7,'#15803D'],[7,7,'#15803D'],[8,7,'#15803D'],
          [2,8,'#166534'],[3,8,'#166534'],[8,8,'#166534'],[9,8,'#166534'],
        ],
        wraith: [
          [4,0,'#FDE047'],[5,0,'#FDE047'],[6,0,'#FDE047'],[7,0,'#FDE047'],
          [3,1,'#FDE047'],[4,1,'#FDE047'],[5,1,'#FDE047'],[6,1,'#FDE047'],[7,1,'#FDE047'],[8,1,'#FDE047'],
          [3,2,'#FDE047'],[4,2,'#000'],[5,2,'#FDE047'],[6,2,'#FDE047'],[7,2,'#000'],[8,2,'#FDE047'],
          [2,3,'#EAB308'],[3,3,'#FDE047'],[4,3,'#FDE047'],[5,3,'#FDE047'],[6,3,'#FDE047'],[7,3,'#FDE047'],[8,3,'#FDE047'],[9,3,'#EAB308'],
          [2,4,'#EAB308'],[3,4,'#EAB308'],[4,4,'#FDE047'],[5,4,'#FDE047'],[6,4,'#FDE047'],[7,4,'#FDE047'],[8,4,'#EAB308'],[9,4,'#EAB308'],
          [3,5,'#A16207'],[4,5,'#EAB308'],[5,5,'#EAB308'],[6,5,'#EAB308'],[7,5,'#EAB308'],[8,5,'#A16207'],
          [4,6,'#A16207'],[5,6,'#A16207'],[6,6,'#A16207'],[7,6,'#A16207'],
          [3,7,'#A16207'],[5,7,'#A16207'],[6,7,'#A16207'],[8,7,'#A16207'],
        ],
        tornado: [
          [5,0,'#9CA3AF'],[6,0,'#9CA3AF'],
          [4,1,'#9CA3AF'],[5,1,'#60A5FA'],[6,1,'#60A5FA'],[7,1,'#9CA3AF'],
          [3,2,'#9CA3AF'],[4,2,'#9CA3AF'],[5,2,'#9CA3AF'],[6,2,'#9CA3AF'],[7,2,'#9CA3AF'],[8,2,'#9CA3AF'],
          [2,3,'#6B7280'],[3,3,'#9CA3AF'],[4,3,'#7C3AED'],[5,3,'#9CA3AF'],[6,3,'#9CA3AF'],[7,3,'#7C3AED'],[8,3,'#9CA3AF'],[9,3,'#6B7280'],
          [2,4,'#6B7280'],[3,4,'#6B7280'],[4,4,'#9CA3AF'],[5,4,'#9CA3AF'],[6,4,'#9CA3AF'],[7,4,'#9CA3AF'],[8,4,'#6B7280'],[9,4,'#6B7280'],
          [3,5,'#6B7280'],[4,5,'#6B7280'],[5,5,'#6B7280'],[6,5,'#6B7280'],[7,5,'#6B7280'],[8,5,'#6B7280'],
          [4,6,'#4B5563'],[5,6,'#4B5563'],[6,6,'#4B5563'],[7,6,'#4B5563'],
          [5,7,'#4B5563'],[6,7,'#4B5563'],
        ],
        yeti: [
          [4,0,'#F5F5F4'],[5,0,'#F5F5F4'],[6,0,'#F5F5F4'],[7,0,'#F5F5F4'],
          [3,1,'#F5F5F4'],[4,1,'#F5F5F4'],[5,1,'#F5F5F4'],[6,1,'#F5F5F4'],[7,1,'#F5F5F4'],[8,1,'#F5F5F4'],
          [2,2,'#F5F5F4'],[3,2,'#3B82F6'],[4,2,'#F5F5F4'],[5,2,'#F5F5F4'],[6,2,'#F5F5F4'],[7,2,'#3B82F6'],[8,2,'#F5F5F4'],[9,2,'#F5F5F4'],
          [2,3,'#E7E5E4'],[3,3,'#F5F5F4'],[4,3,'#F5F5F4'],[5,3,'#F5F5F4'],[6,3,'#F5F5F4'],[7,3,'#F5F5F4'],[8,3,'#F5F5F4'],[9,3,'#E7E5E4'],
          [1,4,'#E7E5E4'],[2,4,'#E7E5E4'],[3,4,'#F5F5F4'],[4,4,'#F5F5F4'],[5,4,'#F5F5F4'],[6,4,'#F5F5F4'],[7,4,'#F5F5F4'],[8,4,'#F5F5F4'],[9,4,'#E7E5E4'],[10,4,'#E7E5E4'],
          [1,5,'#D6D3D1'],[2,5,'#E7E5E4'],[3,5,'#E7E5E4'],[4,5,'#F5F5F4'],[5,5,'#F5F5F4'],[6,5,'#F5F5F4'],[7,5,'#F5F5F4'],[8,5,'#E7E5E4'],[9,5,'#E7E5E4'],[10,5,'#D6D3D1'],
          [3,6,'#D6D3D1'],[4,6,'#E7E5E4'],[5,6,'#E7E5E4'],[6,6,'#E7E5E4'],[7,6,'#E7E5E4'],[8,6,'#D6D3D1'],
          [3,7,'#A8A29E'],[4,7,'#A8A29E'],[7,7,'#A8A29E'],[8,7,'#A8A29E'],
        ],
        rockgolem: [
          [4,0,'#78716C'],[5,0,'#A855F7'],[6,0,'#A855F7'],[7,0,'#78716C'],
          [3,1,'#78716C'],[4,1,'#78716C'],[5,1,'#78716C'],[6,1,'#78716C'],[7,1,'#78716C'],[8,1,'#78716C'],
          [2,2,'#78716C'],[3,2,'#FFD700'],[4,2,'#57534E'],[5,2,'#57534E'],[6,2,'#57534E'],[7,2,'#57534E'],[8,2,'#FFD700'],[9,2,'#78716C'],
          [2,3,'#57534E'],[3,3,'#78716C'],[4,3,'#78716C'],[5,3,'#78716C'],[6,3,'#78716C'],[7,3,'#78716C'],[8,3,'#78716C'],[9,3,'#57534E'],
          [1,4,'#57534E'],[2,4,'#57534E'],[3,4,'#78716C'],[4,4,'#78716C'],[5,4,'#78716C'],[6,4,'#78716C'],[7,4,'#78716C'],[8,4,'#78716C'],[9,4,'#57534E'],[10,4,'#57534E'],
          [1,5,'#44403C'],[2,5,'#57534E'],[3,5,'#57534E'],[4,5,'#A855F7'],[5,5,'#78716C'],[6,5,'#78716C'],[7,5,'#A855F7'],[8,5,'#57534E'],[9,5,'#57534E'],[10,5,'#44403C'],
          [3,6,'#44403C'],[4,6,'#57534E'],[5,6,'#57534E'],[6,6,'#57534E'],[7,6,'#57534E'],[8,6,'#44403C'],
          [3,7,'#44403C'],[4,7,'#44403C'],[7,7,'#44403C'],[8,7,'#44403C'],
        ],
        dragon: [
          [2,0,'#67E8F9'],[3,0,'#67E8F9'],[8,0,'#67E8F9'],[9,0,'#67E8F9'],
          [1,1,'#0EA5E9'],[2,1,'#67E8F9'],[3,1,'#67E8F9'],[8,1,'#67E8F9'],[9,1,'#67E8F9'],[10,1,'#0EA5E9'],
          [1,2,'#0EA5E9'],[2,2,'#0EA5E9'],[3,2,'#67E8F9'],[4,2,'#67E8F9'],[5,2,'#67E8F9'],[6,2,'#67E8F9'],[7,2,'#67E8F9'],[8,2,'#67E8F9'],[9,2,'#0EA5E9'],[10,2,'#0EA5E9'],
          [3,3,'#67E8F9'],[4,3,'#FFD700'],[5,3,'#67E8F9'],[6,3,'#67E8F9'],[7,3,'#FFD700'],[8,3,'#67E8F9'],
          [2,4,'#67E8F9'],[3,4,'#67E8F9'],[4,4,'#67E8F9'],[5,4,'#67E8F9'],[6,4,'#67E8F9'],[7,4,'#67E8F9'],[8,4,'#67E8F9'],[9,4,'#67E8F9'],
          [3,5,'#0EA5E9'],[4,5,'#67E8F9'],[5,5,'#FFF'],[6,5,'#FFF'],[7,5,'#67E8F9'],[8,5,'#0EA5E9'],
          [4,6,'#0EA5E9'],[5,6,'#0EA5E9'],[6,6,'#0EA5E9'],[7,6,'#0EA5E9'],
          [3,7,'#0891B2'],[4,7,'#0891B2'],[7,7,'#0891B2'],[8,7,'#0891B2'],
        ],
        witch: [
          [4,0,'#7C3AED'],[5,0,'#7C3AED'],[6,0,'#7C3AED'],[7,0,'#7C3AED'],
          [3,1,'#7C3AED'],[4,1,'#7C3AED'],[5,1,'#7C3AED'],[6,1,'#7C3AED'],[7,1,'#7C3AED'],[8,1,'#7C3AED'],
          [2,2,'#7C3AED'],[3,2,'#7C3AED'],[4,2,'#7C3AED'],[5,2,'#7C3AED'],[6,2,'#7C3AED'],[7,2,'#7C3AED'],[8,2,'#7C3AED'],[9,2,'#7C3AED'],
          [3,3,'#E9D5FF'],[4,3,'#67E8F9'],[5,3,'#E9D5FF'],[6,3,'#E9D5FF'],[7,3,'#67E8F9'],[8,3,'#E9D5FF'],
          [3,4,'#E9D5FF'],[4,4,'#E9D5FF'],[5,4,'#E9D5FF'],[6,4,'#E9D5FF'],[7,4,'#E9D5FF'],[8,4,'#E9D5FF'],
          [1,5,'#FFD700'],[2,5,'#FFD700'],[3,5,'#7C3AED'],[4,5,'#7C3AED'],[5,5,'#7C3AED'],[6,5,'#7C3AED'],[7,5,'#7C3AED'],[8,5,'#7C3AED'],
          [1,6,'#FFD700'],[3,6,'#7C3AED'],[4,6,'#7C3AED'],[5,6,'#7C3AED'],[6,6,'#7C3AED'],[7,6,'#7C3AED'],[8,6,'#7C3AED'],
          [4,7,'#5B21B6'],[5,7,'#5B21B6'],[6,7,'#5B21B6'],[7,7,'#5B21B6'],
        ],
      };

      const pixels = sprites[type] || sprites.slime;
      
      const shadow = pixels.map(([x, y, color]) => 
        `${x * scale}px ${y * scale}px 0 ${color}`
      ).join(', ');

      const containerStyle = {
        width: 12 * scale,
        height: 12 * scale,
        position: 'relative',
        transform: `${flip ? 'scaleX(-1)' : ''} ${isAttacking ? 'translateX(20px)' : ''}`,
        transition: 'transform 0.2s ease',
        filter: isHit ? 'brightness(0.3) sepia(1) hue-rotate(-50deg) saturate(5)' : 'none',
      };

      const pixelStyle = {
        width: scale,
        height: scale,
        position: 'absolute',
        top: 0,
        left: 0,
        boxShadow: shadow,
        animation: isHit ? 'shake 0.1s infinite' : 'float 1s ease-in-out infinite',
      };

      return (
        <div style={containerStyle}>
          <div style={pixelStyle} />
        </div>
      );
    };

    // HP Bar
    const HPBar = ({ current, max, color = 'red', label }) => {
      const pct = Math.max(0, (current / max) * 100);
      const bg = color === 'red' ? 'bg-red-500' : color === 'blue' ? 'bg-blue-500' : 'bg-green-500';
      
      return (
        <div className="w-full">
          {label && <div className="text-xs font-bold text-white mb-1 drop-shadow">{label}</div>}
          <div className="h-4 bg-gray-800 rounded-full overflow-hidden border-2 border-gray-600 relative">
            <div className={`h-full ${bg} transition-all duration-300`} style={{ width: `${pct}%` }} />
            <div className="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">
              {current}/{max}
            </div>
          </div>
        </div>
      );
    };

    // SVG Canada Map
    const CanadaMap = ({ unlockedRegions, onSelectRegion, currentRegion }) => {
      const provinces = [
        { id: 'atlantic', path: 'M380,180 L400,160 L420,170 L410,190 L390,200 Z', cx: 395, cy: 180 },
        { id: 'quebec', path: 'M320,140 L360,120 L380,140 L370,180 L340,190 L310,170 Z', cx: 345, cy: 155 },
        { id: 'ontario', path: 'M260,160 L300,150 L320,170 L310,200 L270,210 L250,190 Z', cx: 285, cy: 180 },
        { id: 'shield', path: 'M200,100 L280,80 L320,120 L300,160 L240,170 L180,140 Z', cx: 250, cy: 125 },
        { id: 'plains', path: 'M120,140 L180,130 L200,180 L180,220 L120,210 L100,170 Z', cx: 150, cy: 175 },
        { id: 'rockies', path: 'M60,120 L100,110 L120,160 L100,200 L60,190 L40,150 Z', cx: 80, cy: 155 },
        { id: 'arctic', path: 'M100,20 L200,10 L300,30 L320,80 L280,100 L180,110 L100,90 L80,50 Z', cx: 200, cy: 60 },
      ];

      return (
        <svg viewBox="0 0 440 240" className="w-full h-full">
          <rect x="0" y="0" width="440" height="240" fill="#0ea5e9" />
          <ellipse cx="220" cy="140" rx="200" ry="110" fill="#4ade80" />
          
          {provinces.map((prov, idx) => {
            const region = regions.find(r => r.id === prov.id);
            const regionIdx = regions.findIndex(r => r.id === prov.id);
            const unlocked = unlockedRegions.includes(regionIdx);
            const isSelected = currentRegion === regionIdx;
            
            return (
              <g key={prov.id}>
                <path
                  d={prov.path}
                  fill={unlocked ? region.color : '#6b7280'}
                  stroke={isSelected ? '#fff' : '#1f2937'}
                  strokeWidth={isSelected ? 4 : 2}
                  opacity={unlocked ? 1 : 0.5}
                  onClick={() => unlocked && onSelectRegion(regionIdx)}
                  style={{ cursor: unlocked ? 'pointer' : 'not-allowed' }}
                  className={unlocked ? 'hover:brightness-110 transition-all' : ''}
                />
                <text
                  x={prov.cx}
                  y={prov.cy}
                  textAnchor="middle"
                  fontSize="10"
                  fontWeight="bold"
                  fill="#fff"
                  style={{ pointerEvents: 'none', textShadow: '1px 1px 2px #000' }}
                >
                  {unlocked ? region.name : 'üîí'}
                </text>
                {unlocked && (
                  <circle
                    cx={prov.cx}
                    cy={prov.cy + 15}
                    r="8"
                    fill="#fff"
                    stroke={region.color}
                    strokeWidth="2"
                    onClick={() => onSelectRegion(regionIdx)}
                    style={{ cursor: 'pointer' }}
                    className="animate-pulse"
                  />
                )}
              </g>
            );
          })}
        </svg>
      );
    };

    function CanadaAdventure() {
      const [screen, setScreen] = useState('title');
      const [playerName, setPlayerName] = useState('Liam');
      const [level, setLevel] = useState(1);
      const [xp, setXp] = useState(0);
      const [coins, setCoins] = useState(50);
      const [hp, setHp] = useState(10);
      const [maxHp, setMaxHp] = useState(10);
      const [mp, setMp] = useState(5);
      const [maxMp, setMaxMp] = useState(5);
      const [unlockedRegions, setUnlockedRegions] = useState([0]);
      const [totalDefeated, setTotalDefeated] = useState(0);
      const [currentRegion, setCurrentRegion] = useState(0);
      
      const [monster, setMonster] = useState(null);
      const [monsterHp, setMonsterHp] = useState(0);
      const [phase, setPhase] = useState('map');
      const [combo, setCombo] = useState(0);
      const [question, setQuestion] = useState(null);
      const [options, setOptions] = useState([]);
      const [message, setMessage] = useState('');
      const [isDefending, setIsDefending] = useState(false);
      const [selectedAction, setSelectedAction] = useState(null);
      
      const [heroHit, setHeroHit] = useState(false);
      const [monsterHit, setMonsterHit] = useState(false);
      const [heroAttacking, setHeroAttacking] = useState(false);
      
      const [inventory, setInventory] = useState({ potion: 3, bomb: 1 });
      
      // Stats tracking for Lumina integration
      const [questionsCorrect, setQuestionsCorrect] = useState(0);
      const [questionsTotal, setQuestionsTotal] = useState(0);
      const [maxCombo, setMaxCombo] = useState(0);
      const sessionStartRef = useRef(Date.now());
      
      const xpNeeded = level * 100;
      
      // Initialize from LuminaCore on mount
      useEffect(() => {
        if (LUMINA_ENABLED) {
          const player = LuminaCore.getCurrentPlayer();
          if (player) {
            setPlayerName(player.name);
            console.log(`[Canada Adventure] Loaded player: ${player.name}`);
          }
        }
      }, []);

      const gainXP = (amt) => {
        let newXP = xp + amt;
        if (newXP >= xpNeeded) {
          newXP -= xpNeeded;
          setLevel(l => l + 1);
          setMaxHp(h => h + 2);
          setHp(h => Math.min(h + 3, maxHp + 2));
          setMaxMp(m => m + 1);
          setMp(m => m + 1);
          const nextRegion = regions.findIndex(r => r.unlockLevel === level + 1);
          if (nextRegion !== -1 && !unlockedRegions.includes(nextRegion)) {
            setUnlockedRegions(prev => [...prev, nextRegion]);
          }
          setMessage(`‚¨ÜÔ∏è LEVEL UP! Now Level ${level + 1}!`);
        }
        setXp(newXP);
      };

      const startBattle = (regionIdx) => {
        setCurrentRegion(regionIdx);
        const region = regions[regionIdx];
        const pool = monsters[region.id];
        const isBoss = totalDefeated > 0 && totalDefeated % 3 === 2;
        const mon = isBoss ? pool.find(m => m.isBoss) : pool.find(m => !m.isBoss);
        
        setMonster({ ...mon, maxHp: mon.hp });
        setMonsterHp(mon.hp);
        setCombo(0);
        setIsDefending(false);
        setPhase('intro');
        setMessage(`A wild ${mon.name} appears!`);
        
        setTimeout(() => {
          setPhase('player');
          setMessage('Your turn! Choose an action.');
        }, 1500);
      };

      const pickAction = (action) => {
        setSelectedAction(action);
        
        if (action === 'attack' || action === 'special') {
          if (action === 'special') setMp(m => m - 2);
          const region = regions[currentRegion];
          const pool = allQuestions.filter(q => q.region === region.id);
          const qs = pool.length > 0 ? pool : allQuestions;
          const q = qs[Math.floor(Math.random() * qs.length)];
          setQuestion(q);
          setOptions(shuffle([q.a, ...q.wrong]));
          setPhase('question');
          setMessage('Answer correctly to attack!');
        } else if (action === 'defend') {
          setIsDefending(true);
          setMessage('You raise your shield! üõ°Ô∏è');
          setTimeout(() => enemyTurn(), 1000);
        } else if (action === 'item') {
          setPhase('item');
          setMessage('Choose an item:');
        }
      };

      const answer = (ans) => {
        const correct = ans === question.a;
        
        if (correct) {
          const newCombo = combo + 1;
          setCombo(newCombo);
          const dmg = (selectedAction === 'special' ? 3 : 1) + (newCombo > 2 ? Math.floor(newCombo / 2) : 0);
          
          setPhase('attack');
          setHeroAttacking(true);
          setMessage(`‚úÖ CORRECT! ${newCombo > 2 ? `üî• ${newCombo}x COMBO! ` : ''}${dmg} damage!`);
          
          setTimeout(() => {
            setHeroAttacking(false);
            setMonsterHit(true);
            const newHP = Math.max(0, monsterHp - dmg);
            setMonsterHp(newHP);
            
            setTimeout(() => {
              setMonsterHit(false);
              if (newHP <= 0) {
                victory();
              } else {
                enemyTurn();
              }
            }, 500);
          }, 400);
        } else {
          setCombo(0);
          setMessage(`‚ùå Wrong! Answer: ${question.a}`);
          setTimeout(() => enemyTurn(), 1500);
        }
      };

      const enemyTurn = () => {
        setPhase('enemyTurn');
        let dmg = monster.attack;
        if (isDefending) dmg = Math.max(1, Math.floor(dmg / 2));
        
        setMessage(`${monster.name} attacks!${isDefending ? ' Blocked!' : ''} -${dmg} HP`);
        
        setTimeout(() => {
          setHeroHit(true);
          const newHP = Math.max(0, hp - dmg);
          setHp(newHP);
          setIsDefending(false);
          
          setTimeout(() => {
            setHeroHit(false);
            if (newHP <= 0) {
              setPhase('defeat');
              setMessage('üíÄ Defeated...');
              setTimeout(() => setScreen('gameover'), 2000);
            } else {
              setPhase('player');
              setMessage('Your turn!');
            }
          }, 500);
        }, 600);
      };

      const victory = () => {
        setPhase('victory');
        const coinReward = 20 + currentRegion * 10 + (monster.isBoss ? 50 : 0);
        const xpReward = 30 + currentRegion * 15 + (monster.isBoss ? 100 : 0);
        setCoins(c => c + coinReward);
        gainXP(xpReward);
        setTotalDefeated(t => t + 1);
        setMessage(`üéâ VICTORY! +${coinReward}ü™ô +${xpReward}XP`);
        
        setTimeout(() => {
          setPhase('map');
          setMonster(null);
        }, 2500);
      };

      const useItem = (item) => {
        if (inventory[item] <= 0) return;
        setInventory(prev => ({ ...prev, [item]: prev[item] - 1 }));
        
        if (item === 'potion') {
          const heal = 5;
          setHp(h => Math.min(h + heal, maxHp));
          setMessage(`üß™ +${heal} HP!`);
        } else if (item === 'bomb') {
          const dmg = 3;
          const newHP = Math.max(0, monsterHp - dmg);
          setMonsterHp(newHP);
          setMonsterHit(true);
          setMessage(`üí£ BOOM! ${dmg} damage!`);
          setTimeout(() => setMonsterHit(false), 300);
          
          if (newHP <= 0) {
            setTimeout(() => victory(), 800);
            return;
          }
        }
        setTimeout(() => enemyTurn(), 1000);
      };

      const restart = () => {
        setLevel(1); setXp(0); setCoins(50);
        setHp(10); setMaxHp(10); setMp(5); setMaxMp(5);
        setUnlockedRegions([0]); setTotalDefeated(0);
        setInventory({ potion: 3, bomb: 1 });
        setPhase('map'); setMonster(null);
        setScreen('title');
      };

      // TITLE SCREEN
      if (screen === 'title') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-red-600 via-white to-red-600 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-6 max-w-sm w-full text-center border-8 border-red-700">
              <div className="flex justify-center mb-4">
                <PixelSprite type="hero" scale={5} />
              </div>
              <h1 className="text-4xl font-black text-red-600">CANADA</h1>
              <h2 className="text-2xl font-bold text-gray-600 mb-4">ADVENTURE</h2>
              
              <div className="mb-4 p-3 bg-gray-100 rounded-xl">
                <p className="text-sm text-gray-500 mb-2">Your Name:</p>
                <input
                  type="text"
                  value={playerName}
                  onChange={(e) => setPlayerName(e.target.value || 'Hero')}
                  className="w-full p-3 text-center text-xl font-bold border-4 border-gray-300 rounded-xl"
                  maxLength={10}
                />
              </div>
              
              <button
                onClick={() => { setPhase('map'); setScreen('game'); }}
                className="w-full py-4 bg-gradient-to-b from-green-500 to-green-700 text-white rounded-2xl text-xl font-black border-b-4 border-green-900 active:translate-y-1"
              >
                ‚öîÔ∏è START GAME ‚öîÔ∏è
              </button>
            </div>
          </div>
        );
      }

      // GAME OVER
      if (screen === 'gameover') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-gray-800 to-black flex items-center justify-center p-4">
            <div className="bg-gray-900 rounded-3xl p-6 max-w-sm w-full text-center border-4 border-gray-700">
              <div className="text-6xl mb-4">üíÄ</div>
              <h1 className="text-3xl font-black text-red-500 mb-4">GAME OVER</h1>
              <div className="grid grid-cols-2 gap-3 mb-6">
                <div className="bg-gray-800 p-3 rounded-xl">
                  <div className="text-2xl font-black text-yellow-400">{totalDefeated}</div>
                  <div className="text-xs text-gray-400">Defeated</div>
                </div>
                <div className="bg-gray-800 p-3 rounded-xl">
                  <div className="text-2xl font-black text-purple-400">Lv.{level}</div>
                  <div className="text-xs text-gray-400">Level</div>
                </div>
              </div>
              <button onClick={restart} className="w-full py-4 bg-red-600 text-white rounded-xl text-xl font-black">
                üîÑ TRY AGAIN
              </button>
            </div>
          </div>
        );
      }

      // MAP SCREEN
      if (screen === 'game' && phase === 'map') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-sky-400 to-blue-600 p-3">
            <div className="bg-gray-900/90 rounded-xl p-3 mb-3">
              <div className="flex justify-between items-center mb-2">
                <div className="flex items-center gap-2">
                  <div className="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white font-black border-2 border-yellow-400">
                    {level}
                  </div>
                  <span className="text-white font-bold">{playerName}</span>
                </div>
                <span className="text-yellow-400 font-black">ü™ô {coins}</span>
              </div>
              <div className="grid grid-cols-2 gap-2 mb-2">
                <HPBar current={hp} max={maxHp} color="red" />
                <HPBar current={mp} max={maxMp} color="blue" />
              </div>
              <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                <div className="h-full bg-purple-500" style={{ width: `${(xp/xpNeeded)*100}%` }} />
              </div>
            </div>
            
            <div className="bg-gray-900/50 rounded-2xl p-2 mb-3 border-4 border-amber-700">
              <CanadaMap 
                unlockedRegions={unlockedRegions}
                onSelectRegion={startBattle}
                currentRegion={currentRegion}
              />
            </div>
            
            <div className="text-center text-white font-bold mb-3">
              ‚öîÔ∏è Tap a region to battle! ({totalDefeated} defeated)
            </div>
            
            <button
              onClick={() => setScreen('shop')}
              className="w-full py-4 bg-gradient-to-b from-amber-400 to-amber-600 text-white rounded-xl text-lg font-black border-b-4 border-amber-800"
            >
              ü™ô SHOP
            </button>
          </div>
        );
      }

      // SHOP SCREEN
      if (screen === 'shop') {
        return (
          <div className="min-h-screen bg-gradient-to-b from-amber-500 to-orange-600 p-4">
            <div className="max-w-sm mx-auto">
              <div className="flex justify-between mb-4">
                <button onClick={() => setScreen('game')} className="bg-white px-4 py-2 rounded-full font-bold">‚Üê Back</button>
                <div className="bg-white px-4 py-2 rounded-full font-bold">ü™ô {coins}</div>
              </div>
              
              <h1 className="text-3xl font-black text-white text-center mb-4">ü™ô SHOP</h1>
              
              <div className="space-y-3">
                {[
                  { id: 'potion', name: 'Potion', desc: '+5 HP', cost: 20, icon: 'üß™' },
                  { id: 'bomb', name: 'Bomb', desc: '3 damage', cost: 35, icon: 'üí£' },
                ].map(item => (
                  <div key={item.id} className="bg-white rounded-xl p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <span className="text-3xl">{item.icon}</span>
                      <div>
                        <div className="font-bold">{item.name}</div>
                        <div className="text-sm text-gray-500">{item.desc} | Have: {inventory[item.id]}</div>
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        if (coins >= item.cost) {
                          setCoins(c => c - item.cost);
                          setInventory(prev => ({ ...prev, [item.id]: (prev[item.id] || 0) + 1 }));
                        }
                      }}
                      disabled={coins < item.cost}
                      className={`px-4 py-2 rounded-lg font-bold ${coins >= item.cost ? 'bg-green-500 text-white' : 'bg-gray-300'}`}
                    >
                      {item.cost}ü™ô
                    </button>
                  </div>
                ))}
                
                <div className="bg-white rounded-xl p-4 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-3xl">‚ù§Ô∏è‚Äçü©π</span>
                    <div>
                      <div className="font-bold">Full Heal</div>
                      <div className="text-sm text-gray-500">All HP & MP</div>
                    </div>
                  </div>
                  <button
                    onClick={() => {
                      if (coins >= 50) {
                        setCoins(c => c - 50);
                        setHp(maxHp);
                        setMp(maxMp);
                      }
                    }}
                    disabled={coins < 50 || (hp >= maxHp && mp >= maxMp)}
                    className={`px-4 py-2 rounded-lg font-bold ${coins >= 50 && (hp < maxHp || mp < maxMp) ? 'bg-red-500 text-white' : 'bg-gray-300'}`}
                  >
                    50ü™ô
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // BATTLE SCREEN
      if (screen === 'game' && monster) {
        const region = regions[currentRegion];
        
        return (
          <div className={`min-h-screen bg-gradient-to-b ${region.bg} p-3`}>
            <div className="bg-gray-900/80 rounded-xl p-2 mb-2">
              <div className="flex justify-between text-white text-sm mb-1">
                <span className="font-bold">{playerName}</span>
                <span>Lv.{level}</span>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <HPBar current={hp} max={maxHp} color="red" />
                <HPBar current={mp} max={maxMp} color="blue" />
              </div>
            </div>
            
            {combo > 1 && (
              <div className="text-center mb-2">
                <span className="bg-orange-500 text-white px-3 py-1 rounded-full font-black animate-pulse">
                  üî• {combo}x COMBO
                </span>
              </div>
            )}
            
            <div className="bg-black/40 rounded-2xl p-4 mb-3" style={{ minHeight: 180 }}>
              <div className="flex justify-end mb-6">
                <div className="text-center">
                  <div className="mb-2">
                    <HPBar current={monsterHp} max={monster.maxHp} label={monster.name + (monster.isBoss ? ' üëë' : '')} />
                  </div>
                  <PixelSprite type={monster.sprite} scale={4} isHit={monsterHit} flip />
                </div>
              </div>
              
              <div className="flex justify-start">
                <div className="relative">
                  <PixelSprite type="hero" scale={4} isHit={heroHit} isAttacking={heroAttacking} />
                  {isDefending && <div className="absolute -top-2 -right-2 text-2xl">üõ°Ô∏è</div>}
                </div>
              </div>
            </div>
            
            <div className="bg-gray-900/90 rounded-xl p-3 mb-3">
              <p className="text-white font-bold text-center">{message}</p>
            </div>
            
            {phase === 'player' && (
              <div className="grid grid-cols-4 gap-2">
                <button onClick={() => pickAction('attack')} className="bg-red-500 p-3 rounded-xl text-white font-bold">
                  <div className="text-xl">‚öîÔ∏è</div><div className="text-xs">Attack</div>
                </button>
                <button onClick={() => pickAction('special')} disabled={mp < 2} className={`p-3 rounded-xl text-white font-bold ${mp >= 2 ? 'bg-yellow-500' : 'bg-gray-500'}`}>
                  <div className="text-xl">‚ú®</div><div className="text-xs">Special</div>
                </button>
                <button onClick={() => pickAction('defend')} className="bg-blue-500 p-3 rounded-xl text-white font-bold">
                  <div className="text-xl">üõ°Ô∏è</div><div className="text-xs">Defend</div>
                </button>
                <button onClick={() => pickAction('item')} className="bg-green-500 p-3 rounded-xl text-white font-bold">
                  <div className="text-xl">üéí</div><div className="text-xs">Item</div>
                </button>
              </div>
            )}
            
            {phase === 'question' && question && (
              <div>
                <div className="bg-white rounded-xl p-3 mb-3">
                  <p className="font-bold text-gray-800">{question.q}</p>
                </div>
                <div className="grid grid-cols-1 gap-2">
                  {options.map((opt, i) => (
                    <button key={i} onClick={() => answer(opt)} className="w-full p-3 bg-white rounded-xl text-left font-bold flex items-center active:bg-green-100">
                      <span className="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center mr-3 font-black">
                        {['A','B','C','D'][i]}
                      </span>
                      {opt}
                    </button>
                  ))}
                </div>
              </div>
            )}
            
            {phase === 'item' && (
              <div className="grid grid-cols-3 gap-2">
                <button onClick={() => useItem('potion')} disabled={inventory.potion <= 0} className={`p-3 rounded-xl text-center ${inventory.potion > 0 ? 'bg-green-500' : 'bg-gray-500'}`}>
                  <div className="text-xl">üß™</div>
                  <div className="text-white text-xs font-bold">x{inventory.potion}</div>
                </button>
                <button onClick={() => useItem('bomb')} disabled={inventory.bomb <= 0} className={`p-3 rounded-xl text-center ${inventory.bomb > 0 ? 'bg-red-500' : 'bg-gray-500'}`}>
                  <div className="text-xl">üí£</div>
                  <div className="text-white text-xs font-bold">x{inventory.bomb}</div>
                </button>
                <button onClick={() => { setPhase('player'); setMessage('Your turn!'); }} className="p-3 rounded-xl text-center bg-gray-600">
                  <div className="text-xl">‚Ü©Ô∏è</div>
                  <div className="text-white text-xs font-bold">Back</div>
                </button>
              </div>
            )}
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<CanadaAdventure />, document.getElementById('root'));
  </script>
</body>
</html>
