<!DOCTYPE html>
<html lang="en" data-theme="fantasy">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Noyola Hub - Noyola Kids Games</title>
  <meta name="description" content="Educational games for Emma and Liam">
  <meta name="theme-color" content="#1e1b4b">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ®</text></svg>">
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Noyola Hub">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@500;600;700&family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Supabase Client (for cloud sync) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Lumina Core & Cloud Sync -->
  <script src="./shared/supabase-config.js"></script>
  <script src="./shared/lumina-cloud.js"></script>
  <script src="./shared/lumina-core.js"></script>
  
  <!-- Hub Styles -->
  <link rel="stylesheet" href="./shared/styles/hub-themes.css">
  <link rel="stylesheet" href="./shared/styles/hub-base.css">
  <link rel="stylesheet" href="./shared/styles/hub-animations.css">
  <link rel="stylesheet" href="./shared/styles/hub-layout.css">
  <link rel="stylesheet" href="./shared/styles/hub-components.css">
  
</head>
<body>
  <!-- Theme Toggle -->
  <div class="theme-toggle-container">
    <button class="theme-toggle" onclick="toggleTheme()">
      <span class="theme-toggle-icon" id="themeIcon">âœ¨</span>
      <span class="theme-toggle-label" id="themeLabel">Fantasy</span>
    </button>
    <!-- Cloud Sync Status -->
    <span id="cloudStatus" class="cloud-status" title="Cloud sync status" style="margin-left: 0.5rem; font-size: 0.9rem; opacity: 0.7;">
      â˜ï¸
    </span>
  </div>
  
  <!-- Background animation -->
  <div class="bg-animation" id="bgAnimation"></div>
  
  <div class="container">
    <!-- Header -->
    <header>
      <div class="switch-console">
        <!-- Left Joy-Con -->
        <div class="joycon joycon-left">
          <div class="joycon-joystick"></div>
          <div class="joycon-buttons-dpad">
            <div class="dpad-btn dpad-up"></div>
            <div class="dpad-btn dpad-right"></div>
            <div class="dpad-btn dpad-down"></div>
            <div class="dpad-btn dpad-left"></div>
            <div class="dpad-center"></div>
          </div>
          <div class="joycon-minus">âˆ’</div>
          <div class="joycon-capture"></div>
        </div>
        
        <!-- Screen (Video) -->
        <div class="switch-screen">
          <video class="logo-video" autoplay loop muted playsinline>
            <source src="./assets/noyola_hub_animated.mp4" type="video/mp4">
            <h1 class="logo">Noyola Hub</h1>
          </video>
        </div>
        
        <!-- Right Joy-Con -->
        <div class="joycon joycon-right">
          <div class="joycon-buttons-abxy">
            <div class="abxy-btn btn-x">X</div>
            <div class="abxy-btn btn-a">A</div>
            <div class="abxy-btn btn-b">B</div>
            <div class="abxy-btn btn-y">Y</div>
          </div>
          <div class="joycon-joystick"></div>
          <div class="joycon-plus">+</div>
          <div class="joycon-home"></div>
        </div>
      </div>
    </header>
    
    <!-- Active Player Banner -->
    <div class="active-player-banner" id="playerBanner">
      <div class="player-info">
        <img src="./assets/Emma_Lumina.png" alt="Player" class="player-avatar-small" id="playerAvatar" onclick="showProfileSelect()">
        <div class="player-details">
          <h3><span id="playerName">Select Player</span> <span class="level-badge" id="levelBadge">Lv. 1</span></h3>
          <div class="player-title" id="playerTitle">Click avatar to switch</div>
        </div>
      </div>
      
      <div class="xp-bar-container">
        <div class="xp-bar-label">
          <span id="xpText">0 / 100 XP</span>
          <span id="levelTitle">Apprentice</span>
        </div>
        <div class="xp-bar">
          <div class="xp-bar-fill" id="xpFill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="player-stats">
        <div class="stat-box">
          <div class="stat-value coins" id="coinsDisplay">0</div>
          <div class="stat-label">Coins</div>
        </div>
        <div class="stat-box">
          <div class="stat-value points" id="pointsDisplay">0</div>
          <div class="stat-label">â­ Points</div>
        </div>
        <div class="stat-box">
          <div class="stat-value streak" id="streakDisplay">0ğŸ”¥</div>
          <div class="stat-label">Streak</div>
        </div>
      </div>
    </div>
    
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Games Section (Left) -->
      <section class="games-section">
        <h2>ğŸ® Choose Your Adventure</h2>
        <div class="games-grid" id="gamesGrid">
          <!-- Games will be populated by JS -->
        </div>
      </section>
      
      <!-- Sidebar (Right) -->
      <aside>
        <!-- Leaderboard -->
        <div class="panel" id="leaderboardPanel">
          <div class="panel-header">
            <h3 class="panel-title">ğŸ† Leaderboard</h3>
          </div>
          <div id="leaderboardContent">
            <!-- Populated by JS -->
          </div>
          
          <!-- Family Quest -->
          <div class="family-quest" id="familyQuest" style="display: none;">
            <div class="family-quest-header">
              <span class="family-quest-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Family Quest</span>
              <span class="family-quest-reward" id="familyQuestReward">Pizza Night!</span>
            </div>
            <div class="family-quest-progress">
              <div class="family-quest-fill" id="familyQuestFill" style="width: 0%"></div>
            </div>
            <div class="family-quest-text" id="familyQuestText">0 / 500 XP Together</div>
          </div>
          
          <!-- Daily Challenges -->
          <div class="panel" style="margin-top: 1rem;">
            <div class="panel-header">
              <h3 class="panel-title">ğŸ“… Daily Challenges</h3>
            </div>
            <div id="dailyChallengesContent">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
        
        <!-- Rewards Preview -->
        <div class="panel" style="margin-top: 1rem;">
          <div class="panel-header">
            <h3 class="panel-title">ğŸ Rewards</h3>
          </div>
          <div class="rewards-preview" id="rewardsPreview">
            <!-- Populated by JS -->
          </div>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="view-all-btn" onclick="showRewardsModal()">View All Rewards</button>
            <button class="view-all-btn" onclick="showShopModal()">ğŸ›’ Shop</button>
          </div>
          
          <!-- Usage Metrics (Parent Profiles Only) -->
          <div class="panel" id="usageMetricsPanel" style="margin-top: 1rem; display: none;">
            <div class="panel-header">
              <h3 class="panel-title">ğŸ“Š Usage Metrics</h3>
            </div>
            <div id="usageMetricsContent">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </aside>
    </div>
    
  <!-- Footer -->
  <footer>
    <p>Made with â¤ï¸ by Dad</p>
  </footer>
  
  <!-- Tutorial Modal -->
  <div class="modal-overlay" id="tutorialModal" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2>ğŸ“ Welcome to Noyola Hub!</h2>
        <button class="modal-close" onclick="closeTutorial()">Ã—</button>
      </div>
      <div class="modal-content" id="tutorialContent">
        <!-- Tutorial content will be populated by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeTutorial()">Skip Tutorial</button>
        <button class="btn-primary" onclick="nextTutorialStep()">Next â†’</button>
      </div>
    </div>
  </div>
  </div>
  
  <!-- Profile Select Modal -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h2>ğŸ‘‹ Who's Playing?</h2>
      <div class="profile-select-grid" id="profileSelectGrid">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>
  
  <!-- Rewards Modal -->
  <div class="modal-overlay" id="rewardsModal">
    <div class="modal" style="max-width: 600px;">
      <h2>ğŸ Reward Shop</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;">
        You have <span id="modalPointsDisplay" style="color: var(--accent-green); font-weight: bold;">0</span> reward points
      </p>
      <div class="rewards-grid" id="rewardsGrid">
        <!-- Populated by JS -->
      </div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button class="view-all-btn" onclick="showRewardHistoryModal()">ğŸ“œ View History</button>
        <button class="view-all-btn" onclick="closeRewardsModal()">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Reward History Modal -->
  <div class="modal-overlay" id="rewardHistoryModal">
    <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
      <h2>ğŸ“œ Reward History</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;">
        All rewards you've claimed and when they were fulfilled
      </p>
      <div id="rewardHistoryList">
        <!-- Populated by JS -->
      </div>
      <button class="view-all-btn" onclick="closeRewardHistoryModal()" style="margin-top: 1rem;">Close</button>
    </div>
  </div>
  
  <!-- Shop Modal -->
  <div class="modal-overlay" id="shopModal">
    <div class="modal" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
      <h2>ğŸ›’ Coin Shop</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;">
        You have <span id="shopCoinsDisplay" style="color: var(--accent-gold); font-weight: bold;">0</span> coins
      </p>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: center; flex-wrap: wrap;">
        <button class="shop-category-btn active" onclick="filterShopItems('all')">All</button>
        <button class="shop-category-btn" onclick="filterShopItems('cosmetic')">Cosmetics</button>
        <button class="shop-category-btn" onclick="filterShopItems('powerup')">Power-ups</button>
        <button class="shop-category-btn" onclick="filterShopItems('unlockable')">Unlockables</button>
      </div>
      <div class="shop-grid" id="shopGrid">
        <!-- Populated by JS -->
      </div>
      <button class="view-all-btn" onclick="closeShopModal()" style="margin-top: 1rem;">Close</button>
    </div>
  </div>
  
  <!-- Profile PIN Modal -->
  <div class="modal-overlay" id="profilePinModal">
    <div class="modal" style="max-width: 400px;">
      <h2 id="profilePinTitle">ğŸ” Enter PIN</h2>
      <p style="text-align: center; color: var(--text-secondary);">Enter your 4-digit PIN to access this profile</p>
      <div class="pin-input-container">
        <input type="password" maxlength="1" class="pin-digit" id="profilePin1">
        <input type="password" maxlength="1" class="pin-digit" id="profilePin2">
        <input type="password" maxlength="1" class="pin-digit" id="profilePin3">
        <input type="password" maxlength="1" class="pin-digit" id="profilePin4">
      </div>
      <div class="pin-error" id="profilePinError" style="display: none;">Incorrect PIN</div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeProfilePinModal()">Cancel</button>
        <button class="modal-btn primary" onclick="submitProfilePin()">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Parent PIN Modal (for rewards) -->
  <div class="modal-overlay" id="pinModal">
    <div class="modal" style="max-width: 400px;">
      <h2>ğŸ” Parent Approval</h2>
      <p style="text-align: center; color: var(--text-secondary);">Enter PIN to claim reward</p>
      <div class="pin-input-container">
        <input type="password" maxlength="1" class="pin-digit" id="pin1">
        <input type="password" maxlength="1" class="pin-digit" id="pin2">
        <input type="password" maxlength="1" class="pin-digit" id="pin3">
        <input type="password" maxlength="1" class="pin-digit" id="pin4">
      </div>
      <div class="pin-error" id="pinError" style="display: none;">Incorrect PIN</div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closePinModal()">Cancel</button>
        <button class="modal-btn primary" onclick="submitPin()">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- Hub Scripts -->
  <script src="./shared/scripts/hub-config.js"></script>
  <script src="./shared/scripts/hub-theme.js"></script>
  <script src="./shared/scripts/hub-ui.js"></script>
  <script src="./shared/scripts/hub-games.js"></script>
  <script src="./shared/scripts/hub-modals.js"></script>
  <script src="./shared/scripts/hub-init.js"></script>
  
  <!-- Service Worker Registration (Offline Support) -->
  <script>
    // Register service worker for offline play
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('âœ… Service Worker registered:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('ğŸ”„ Service Worker: Update found');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available, prompt user to refresh
                  console.log('âœ¨ Service Worker: New version ready');
                  showToast('ğŸ‰ Update available! Refresh to get the latest version.', 5000);
                }
              });
            });
          })
          .catch((error) => {
            console.error('âŒ Service Worker registration failed:', error);
          });
      });
    } else {
      console.warn('âš ï¸ Service Worker not supported in this browser');
    }
    
    // iOS Safari "Add to Home Screen" prompt
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    function isInStandaloneMode() {
      return window.navigator.standalone === true || 
             window.matchMedia('(display-mode: standalone)').matches;
    }
    
    // Show install prompt for iOS Safari users not in standalone mode
    if (isIOS() && !isInStandaloneMode()) {
      setTimeout(() => {
        const installBanner = document.createElement('div');
        installBanner.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
          z-index: 10000;
          max-width: 90%;
          text-align: center;
          font-family: 'Quicksand', sans-serif;
          animation: slideUp 0.3s ease;
        `;
        installBanner.innerHTML = `
          <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
            ğŸ“± Install Noyola Hub
          </div>
          <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;">
            Tap <span style="font-weight: 700;">Share</span> â†—ï¸ then 
            <span style="font-weight: 700;">"Add to Home Screen"</span>
          </div>
          <button onclick="this.parentElement.remove()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
          ">Got it!</button>
        `;
        document.body.appendChild(installBanner);
        
        // Add slide up animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
        
        // Auto-hide after 15 seconds
        setTimeout(() => {
          if (installBanner.parentElement) {
            installBanner.style.animation = 'slideDown 0.3s ease';
            setTimeout(() => installBanner.remove(), 300);
          }
        }, 15000);
      }, 3000); // Show after 3 seconds
    }
  </script>

</body>
</html>
